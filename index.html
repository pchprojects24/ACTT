<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACTT Reference</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#121b2e;
      --panel2:#0f172a;
      --text:#e7eefc;
      --muted:#a9b7d6;
      --border:rgba(231,238,252,.12);
      --accent:#5aa7ff;
      --accent2:#7cdaff;
      --danger:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --radius2:10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 20% 0%, rgba(90,167,255,.20), transparent 55%),
                  radial-gradient(900px 600px at 100% 20%, rgba(124,218,255,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height: 100vh;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.72));
      border-bottom: 1px solid var(--border);
    }
    .wrap{ max-width: 1100px; margin: 0 auto; padding: 14px 14px; }
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap: wrap;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      min-width: 220px;
      cursor: pointer;
    }
    .logo{
      width: 38px; height: 38px; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: var(--shadow);
    }
    .titleblock{ display:flex; flex-direction:column; line-height:1.1; }
    .titleblock .title{ font-weight: 800; letter-spacing: .2px; }
    .titleblock .subtitle{ color: var(--muted); font-size: 12.5px; margin-top: 3px; }

    .search{
      flex: 1;
      min-width: 220px;
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
    }
    .search input{
      width: min(520px, 100%);
      padding: 10px 12px;
      background: rgba(18,27,46,.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      outline: none;
    }
    .search input::placeholder{ color: rgba(169,183,214,.75); }
    .btn{
      border: 1px solid var(--border);
      background: rgba(18,27,46,.85);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }

    main .wrap{ padding-top: 16px; padding-bottom: 26px; }

    .panel{
      background: rgba(18,27,46,.72);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel h2{
      margin:0;
      padding: 14px 14px 8px;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .panel .meta{
      padding: 0 14px 14px;
      color: var(--muted);
      font-size: 13px;
    }

    /* HOME VIEW - Large Section Buttons */
    .homeView{
      display: block;
    }
    .homeGrid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
      padding: 14px;
    }
    .sectionBtn{
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 20px;
      border: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(15,23,42,.8), rgba(18,27,46,.9));
      border-radius: var(--radius);
      cursor: pointer;
      touch-action: manipulation;
      transition: border-color 0.15s, transform 0.1s;
      text-align: left;
      min-height: 100px;
    }
    .sectionBtn:hover{
      border-color: rgba(90,167,255,.55);
    }
    .sectionBtn:active{
      transform: translateY(2px);
    }
    .sectionBtn .sectionLabel{
      font-weight: 800;
      font-size: 17px;
      margin-bottom: 8px;
      color: var(--text);
    }
    .sectionBtn .sectionDesc{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }
    .sectionBtn .topicCount{
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(90,167,255,.15);
      color: var(--accent2);
      font-size: 12px;
      font-weight: 600;
    }
    .sectionBtn.hidden{
      display: none;
    }

    /* SECTION VIEW - Sub-buttons */
    .sectionView{
      display: none;
    }
    .sectionView.active{
      display: block;
    }
    .sectionHeader{
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .backBtn{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 14px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,.7);
      border-radius: 12px;
      color: var(--text);
      cursor: pointer;
      touch-action: manipulation;
      font-size: 14px;
      font-weight: 600;
    }
    .backBtn:hover{
      border-color: rgba(90,167,255,.55);
    }
    .backBtn:active{
      transform: translateY(1px);
    }
    .sectionViewTitle{
      font-weight: 800;
      font-size: 18px;
      flex: 1;
    }
    .topicBtns{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 14px;
    }
    .topic{
      border: 1px solid var(--border);
      background: rgba(15,23,42,.62);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 14px;
      line-height: 1.2;
      touch-action: manipulation;
      text-align: left;
      max-width: 100%;
    }
    .topic:hover{ border-color: rgba(90,167,255,.55); }
    .topic.active{
      background: linear-gradient(135deg, rgba(90,167,255,.28), rgba(124,218,255,.18));
      border-color: rgba(90,167,255,.65);
    }
    .topic.hidden{
      display: none;
    }

    /* TOPIC VIEW - Viewer Panel */
    .topicView{
      display: none;
    }
    .topicView.active{
      display: block;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .viewer{ position: static !important; }
    }
    .viewer{
      position: sticky;
      top: 88px;
    }
    .viewerHeader{
      padding: 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(15,23,42,.55);
    }
    .viewerNav{
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .crumb{
      color: var(--muted);
      font-size: 12.5px;
    }
    .viewerTitle{
      margin-top: 6px;
      font-size: 16px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .viewerBody{
      padding: 14px;
    }
    .hint{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .callout{
      margin-top: 12px;
      border: 1px dashed rgba(90,167,255,.45);
      background: rgba(90,167,255,.08);
      border-radius: var(--radius2);
      padding: 12px;
    }
    .codehint{
      margin-top: 10px;
      background: rgba(0,0,0,.22);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      font-family: var(--mono);
      font-size: 12px;
      overflow:auto;
      color: rgba(231,238,252,.95);
      white-space: pre;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
    }

    /* Accordion */
    details{
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(15,23,42,.55);
      margin-top: 10px;
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding: 11px 12px;
      font-weight: 700;
      list-style: none;
      outline: none;
    }
    summary::-webkit-details-marker{ display:none; }
    details[open] summary{
      border-bottom: 1px solid var(--border);
      background: rgba(90,167,255,.10);
    }
    .accBody{
      padding: 10px 12px 12px;
      color: rgba(231,238,252,.95);
      font-size: 13.5px;
      line-height: 1.45;
    }
    .accBody ul{ margin: 8px 0 0 18px; padding:0; }
    .accBody li{ margin: 4px 0; }
    .mutedSmall{
      color: var(--muted);
      font-size: 12.5px;
      margin-top: 10px;
    }

    /* Topic list panel in topic view */
    .topicListPanel{
      max-height: 70vh;
      overflow-y: auto;
    }
    .topicListPanel .topicBtns{
      padding: 10px;
    }
    .topicListPanel .topic{
      width: 100%;
    }

    footer{
      color: rgba(169,183,214,.8);
      font-size: 12.5px;
      padding: 14px 14px 24px;
      text-align:center;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand" id="brandHome">
        <div class="logo" aria-hidden="true"></div>
        <div class="titleblock">
          <div class="title">ACTT Reference</div>
          <div class="subtitle">Offline field reference (structure first; content added topic-by-topic)</div>
        </div>
      </div>

      <div class="search">
        <input id="searchInput" type="search" placeholder="Search..." aria-label="Search" />
        <button class="btn" id="clearBtn" type="button">Clear</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <!-- HOME VIEW: 7 Large Section Buttons -->
    <div id="homeView" class="homeView">
      <section class="panel" aria-label="ACTT sections">
        <h2>Select a Section</h2>
        <div class="meta">
          Tap a section to see its topics. Content is added topic-by-topic via NotebookLM extractions.
        </div>
        <div id="homeGrid" class="homeGrid"></div>
      </section>
    </div>

    <!-- SECTION VIEW: Sub-buttons for a section -->
    <div id="sectionView" class="sectionView">
      <section class="panel" aria-label="Section topics">
        <div class="sectionHeader">
          <button class="backBtn" id="backToHome" type="button">← Back to Home</button>
          <div class="sectionViewTitle" id="sectionViewTitle">Section</div>
        </div>
        <div id="topicBtnsContainer" class="topicBtns"></div>
      </section>
    </div>

    <!-- TOPIC VIEW: Viewer panel -->
    <div id="topicView" class="topicView">
      <div class="grid">
        <!-- LEFT: Topic list for this section -->
        <section class="panel topicListPanel" aria-label="Topic list">
          <div class="sectionHeader">
            <button class="backBtn" id="backToSection" type="button">← Back</button>
            <div class="sectionViewTitle" id="topicListTitle">Topics</div>
          </div>
          <div id="topicListBtns" class="topicBtns"></div>
        </section>

        <!-- RIGHT: Viewer -->
        <aside class="panel viewer" aria-label="Topic viewer">
          <div class="viewerHeader">
            <div class="viewerNav">
              <button class="backBtn" id="backToHome2" type="button">← Home</button>
            </div>
            <div class="crumb" id="crumb">Section</div>
            <div class="viewerTitle" id="viewerTitle">Topic</div>
          </div>
          <div class="viewerBody" id="viewerBody">
            <div class="hint">Select a topic to view its content.</div>
          </div>
        </aside>
      </div>
    </div>
  </div>
</main>

<footer>
  ACTT Reference • Single-file offline shell • Version 0.2
</footer>

<script>
  /******************************************************************
   * BUTTON MAP (embedded; no file loading)
   * Structure: sections -> topics (sub-buttons)
   ******************************************************************/
  const MAP = {
    appTitle: "ACTT Reference",
    version: "0.2",
    sections: [
      {
        id: "airway_breathing",
        label: "Airway & Breathing",
        description: "Airway decisions, RSI, failed airway, ventilation/oxygenation, thoracic interventions.",
        topics: [
          { id: "airway_assessment_plan", label: "Airway assessment & airway plan" },
          { id: "rsi_intubation_workflow", label: "RSI / intubation workflow" },
          { id: "failed_airway_rescue", label: "Failed airway & rescue pathway (SGA → cannot intubate/cannot ventilate)" },
          { id: "surgical_airway_fona", label: "Surgical airway (FONA / cric)" },
          { id: "ventilation_management", label: "Ventilation management (setup + ongoing)" },
          { id: "oxygenation_strategy", label: "Oxygenation strategy (FiO₂/PEEP; context-dependent targets)" },
          { id: "thoracic_trauma_interventions", label: "Thoracic trauma interventions (needle decompression, chest tube)" }
        ]
      },
      {
        id: "shock_resuscitation",
        label: "Shock & Resuscitation",
        description: "Perfusion assessment, fluid strategy, vasopressors, condition-specific targets.",
        topics: [
          { id: "shock_recognition_perfusion", label: "Shock recognition & perfusion assessment" },
          { id: "fluid_responsiveness", label: "Fluid responsiveness (dynamic assessments)" },
          { id: "sepsis_resuscitation", label: "Sepsis resuscitation (fluids → pressors decision framework)" },
          { id: "burn_resuscitation", label: "Burn resuscitation (avoid \"fluid creep\")" },
          { id: "vasopressors", label: "Vasopressors (selection, administration, safety)" },
          { id: "targets_by_condition", label: "Targets by condition (e.g., sepsis vs TBI)" }
        ]
      },
      {
        id: "neuro_burns_environmental",
        label: "Neurotrauma, Burns & Environmental",
        description: "TBI priorities, burns assessment/resus, hypothermia, ortho reductions, complications.",
        topics: [
          { id: "tbi_secondary_injury", label: "TBI: secondary injury prevention bundle" },
          { id: "tbi_elevated_icp", label: "TBI: elevated ICP concern (recognition + management options)" },
          { id: "tbi_seizure", label: "TBI: seizure prevention/treatment" },
          { id: "burns_assessment", label: "Burns: assessment (TBSA/severity)" },
          { id: "burns_wound_care", label: "Burns: wound care & dressings" },
          { id: "burns_escharotomy", label: "Burns: escharotomy (indications)" },
          { id: "hypothermia_rewarming", label: "Hypothermia: staging & rewarming" },
          { id: "ortho_compartment", label: "Ortho: reductions & compartment syndrome watch" }
        ]
      },
      {
        id: "sepsis_infectious",
        label: "Sepsis & Infectious Syndromes",
        description: "Recognition, key differentials, antimicrobials, source control in austere context.",
        topics: [
          { id: "sepsis_recognition", label: "Sepsis recognition & initial actions" },
          { id: "differentials_tropical", label: "Key differentials in austere/tropical context (malaria, dengue patterns)" },
          { id: "antibiotics_empiric", label: "Antibiotics: empiric selection & timing" },
          { id: "source_control", label: "Source control (what to identify, what's feasible)" },
          { id: "scoring_early_warning", label: "Scoring / early warning tools (qSOFA/adapted tools)" }
        ]
      },
      {
        id: "analgesia_sedation",
        label: "Analgesia, Sedation & High-Risk Meds",
        description: "PSA, pain strategies, core drug profiles, reversals, fibrinolysis package.",
        topics: [
          { id: "procedural_sedation", label: "Procedural sedation: setup & safety" },
          { id: "ketamine_use", label: "Ketamine use (sedation/analgesia roles)" },
          { id: "multimodal_pain", label: "Multimodal pain management" },
          { id: "core_drug_profiles", label: "Core drug profiles & contraindications (ACTT set)" },
          { id: "reversal_rescue", label: "Reversal/rescue agents" },
          { id: "stemi_fibrinolysis", label: "STEMI: fibrinolysis package (screen + adjuncts)" }
        ]
      },
      {
        id: "monitoring_diagnostics",
        label: "Monitoring & Diagnostics",
        description: "ECG, POCT, access, output monitoring for trending/resus.",
        topics: [
          { id: "ecg_interpretation", label: "ECG interpretation (ACTT-relevant)" },
          { id: "stemi_recognition", label: "STEMI recognition" },
          { id: "poct_interpretation", label: "POCT interpretation (lactate/acid-base, glucose, electrolytes)" },
          { id: "vascular_access", label: "Vascular access (IV/IO ± central)" },
          { id: "urine_output_monitoring", label: "Urine output monitoring (Foley, trending)" }
        ]
      },
      {
        id: "operations_pfc_team",
        label: "Operations / PFC / Team",
        description: "Resource-limited decisions, documentation, telemedicine, agitation control, team behaviors.",
        topics: [
          { id: "resource_limited_ethics", label: "Resource-limited decision-making & ethics (triage/termination)" },
          { id: "pfc_documentation", label: "Prolonged field care documentation (flowsheets, trending 24–72h)" },
          { id: "telemedicine_consult", label: "Telemedicine / remote consult workflow" },
          { id: "agitation_management", label: "Agitation/combative patient management (de-escalation → restraint → chemical)" },
          { id: "adapting_guidelines", label: "Adapting guidelines to constraints (vent, pressors, RRT availability)" }
        ]
      }
    ]
  };

  /******************************************************************
   * CONTENT STORE (intentionally empty at start)
   * Add NotebookLM extractions here later, keyed by topic id.
   ******************************************************************/
  const CONTENT = {
    // Example (leave commented until you paste real content):
    // "airway_assessment_plan": {
    //   "Quick actions": ["..."],
    //   "Indications / triggers": ["..."],
    //   "Decision points": ["..."],
    //   "Pitfalls": ["..."],
    //   "Source anchors": ["Doc — slide/page ..."]
    // }
  };

  /******************************************************************
   * UI STATE & ELEMENTS
   ******************************************************************/
  // Views
  const homeView = document.getElementById("homeView");
  const sectionView = document.getElementById("sectionView");
  const topicView = document.getElementById("topicView");

  // Home view elements
  const homeGrid = document.getElementById("homeGrid");

  // Section view elements
  const backToHomeBtn = document.getElementById("backToHome");
  const sectionViewTitle = document.getElementById("sectionViewTitle");
  const topicBtnsContainer = document.getElementById("topicBtnsContainer");

  // Topic view elements
  const backToSectionBtn = document.getElementById("backToSection");
  const backToHome2Btn = document.getElementById("backToHome2");
  const topicListTitle = document.getElementById("topicListTitle");
  const topicListBtns = document.getElementById("topicListBtns");
  const crumbEl = document.getElementById("crumb");
  const titleEl = document.getElementById("viewerTitle");
  const bodyEl = document.getElementById("viewerBody");

  // Search elements
  const searchInput = document.getElementById("searchInput");
  const clearBtn = document.getElementById("clearBtn");
  const brandHome = document.getElementById("brandHome");

  // State
  let currentView = "home"; // "home" | "section" | "topic"
  let currentSectionId = null;
  let currentTopicId = null;

  /******************************************************************
   * UTILITY FUNCTIONS
   ******************************************************************/
  function normalize(s) {
    return (s || "").toLowerCase().trim();
  }

  function escapeHtml(str) {
    return str
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function getSection(sectionId) {
    return MAP.sections.find(s => s.id === sectionId);
  }

  function getTopic(sectionId, topicId) {
    const section = getSection(sectionId);
    if (!section) return null;
    return section.topics.find(t => t.id === topicId);
  }

  /******************************************************************
   * VIEW MANAGEMENT
   ******************************************************************/
  function showView(view) {
    currentView = view;
    homeView.style.display = view === "home" ? "block" : "none";
    sectionView.className = view === "section" ? "sectionView active" : "sectionView";
    topicView.className = view === "topic" ? "topicView active" : "topicView";

    // Update search placeholder
    if (view === "home") {
      searchInput.placeholder = "Search sections...";
    } else if (view === "section") {
      searchInput.placeholder = "Search topics in this section...";
    } else {
      searchInput.placeholder = "Search topics...";
    }

    // Clear search when switching views
    searchInput.value = "";
    applySearch("");
  }

  /******************************************************************
   * HOME VIEW RENDERING
   ******************************************************************/
  function renderHomeView() {
    homeGrid.innerHTML = "";

    MAP.sections.forEach(sec => {
      const btn = document.createElement("button");
      btn.className = "sectionBtn";
      btn.type = "button";
      btn.dataset.sectionId = sec.id;

      btn.innerHTML = `
        <div class="sectionLabel">${escapeHtml(sec.label)}</div>
        <div class="sectionDesc">${escapeHtml(sec.description)}</div>
        <div class="topicCount">${sec.topics.length} topics</div>
      `;

      btn.addEventListener("click", () => {
        currentSectionId = sec.id;
        renderSectionView(sec.id);
        showView("section");
      });

      homeGrid.appendChild(btn);
    });
  }

  /******************************************************************
   * SECTION VIEW RENDERING
   ******************************************************************/
  function renderSectionView(sectionId) {
    const section = getSection(sectionId);
    if (!section) return;

    sectionViewTitle.textContent = section.label;
    topicBtnsContainer.innerHTML = "";

    section.topics.forEach(topic => {
      const btn = document.createElement("button");
      btn.className = "topic";
      btn.type = "button";
      btn.textContent = topic.label;
      btn.dataset.topicId = topic.id;

      btn.addEventListener("click", () => {
        currentTopicId = topic.id;
        renderTopicView(sectionId, topic.id);
        showView("topic");
      });

      topicBtnsContainer.appendChild(btn);
    });
  }

  /******************************************************************
   * TOPIC VIEW RENDERING
   ******************************************************************/
  function renderTopicView(sectionId, topicId) {
    const section = getSection(sectionId);
    const topic = getTopic(sectionId, topicId);
    if (!section || !topic) return;

    // Update header
    topicListTitle.textContent = section.label;
    crumbEl.textContent = section.label;
    titleEl.textContent = topic.label;

    // Render topic list (left side)
    topicListBtns.innerHTML = "";
    section.topics.forEach(t => {
      const btn = document.createElement("button");
      btn.className = "topic" + (t.id === topicId ? " active" : "");
      btn.type = "button";
      btn.textContent = t.label;
      btn.dataset.topicId = t.id;

      btn.addEventListener("click", () => {
        currentTopicId = t.id;
        renderTopicView(sectionId, t.id);
      });

      topicListBtns.appendChild(btn);
    });

    // Render viewer content (right side)
    renderViewerContent(topicId, topic.label);
  }

  function renderViewerContent(topicId, topicLabel) {
    const data = CONTENT[topicId];

    // Empty state
    if (!data) {
      bodyEl.innerHTML = `
        <div class="hint">
          <div style="font-weight:800;margin-bottom:6px;">No content added yet</div>
          <div>
            This topic is ready for your first NotebookLM extraction.
            When you paste it, we'll format it into standard sections (Quick actions, Indications, Decision points, etc.)
            and store it under <span class="pill">${escapeHtml(topicId)}</span>.
          </div>
        </div>

        <div class="callout">
          <div style="font-weight:800;margin-bottom:6px;">Next action (for you)</div>
          <div class="hint">
            Run one NotebookLM extraction for:
            <span class="pill">${escapeHtml(topicLabel)}</span>
            and paste the output back into this chat.
          </div>
          <div class="mutedSmall">
            I'll then give you the exact content block to paste into this file—only for this single topic.
          </div>
        </div>

        <div class="callout">
          <div style="font-weight:800;margin-bottom:6px;">Content structure example</div>
          <div class="codehint" aria-label="Content placeholder example">
CONTENT["${escapeHtml(topicId)}"] = {
  "Quick actions": [
    "…",
    "…"
  ],
  "Indications / triggers": [
    "…"
  ],
  "Decision points": [
    "…"
  ],
  "Pitfalls": [
    "…"
  ],
  "Source anchors": [
    "Doc — slide/page …",
    "Doc — slide/page …"
  ]
};
          </div>
        </div>
      `;
      return;
    }

    // Render filled topic as accordions
    const keys = Object.keys(data);
    const acc = keys.map(k => {
      const items = Array.isArray(data[k]) ? data[k] : [String(data[k])];
      const lis = items.map(x => `<li>${escapeHtml(String(x))}</li>`).join("");
      return `
        <details open>
          <summary>${escapeHtml(k)}</summary>
          <div class="accBody"><ul>${lis}</ul></div>
        </details>
      `;
    }).join("");

    bodyEl.innerHTML = `
      <div class="hint">
        Content loaded from embedded <span class="pill">CONTENT</span> store.
      </div>
      ${acc}
    `;
  }

  /******************************************************************
   * SEARCH FUNCTIONALITY
   ******************************************************************/
  function applySearch(query) {
    const q = normalize(query);

    if (currentView === "home") {
      // Filter section buttons on home view
      const sectionBtns = homeGrid.querySelectorAll(".sectionBtn");
      sectionBtns.forEach(btn => {
        const sectionId = btn.dataset.sectionId;
        const section = getSection(sectionId);
        if (!section) return;

        const hay = normalize(section.label + " " + section.description);
        const topicMatch = section.topics.some(t => normalize(t.label).includes(q));

        if (!q || hay.includes(q) || topicMatch) {
          btn.classList.remove("hidden");
        } else {
          btn.classList.add("hidden");
        }
      });
    } else if (currentView === "section") {
      // Filter topic buttons within current section
      const topicBtns = topicBtnsContainer.querySelectorAll(".topic");
      topicBtns.forEach(btn => {
        const label = btn.textContent;
        if (!q || normalize(label).includes(q)) {
          btn.classList.remove("hidden");
        } else {
          btn.classList.add("hidden");
        }
      });
    } else if (currentView === "topic") {
      // Filter topic buttons in the left panel
      const topicBtns = topicListBtns.querySelectorAll(".topic");
      topicBtns.forEach(btn => {
        const label = btn.textContent;
        if (!q || normalize(label).includes(q)) {
          btn.classList.remove("hidden");
        } else {
          btn.classList.add("hidden");
        }
      });
    }
  }

  /******************************************************************
   * EVENT LISTENERS
   ******************************************************************/
  // Search
  searchInput.addEventListener("input", () => {
    applySearch(searchInput.value);
  });

  clearBtn.addEventListener("click", () => {
    searchInput.value = "";
    applySearch("");
    searchInput.focus();
  });

  // Navigation
  brandHome.addEventListener("click", () => {
    showView("home");
    renderHomeView();
  });

  backToHomeBtn.addEventListener("click", () => {
    showView("home");
    renderHomeView();
  });

  backToSectionBtn.addEventListener("click", () => {
    if (currentSectionId) {
      renderSectionView(currentSectionId);
      showView("section");
    } else {
      showView("home");
      renderHomeView();
    }
  });

  backToHome2Btn.addEventListener("click", () => {
    showView("home");
    renderHomeView();
  });

  /******************************************************************
   * INITIAL RENDER
   ******************************************************************/
  renderHomeView();
  showView("home");
</script>
</body>
</html>
